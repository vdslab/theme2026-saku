# Active Context: トーラス階層割当システム

## 現在の作業フォーカス

**ステータス**: ✅ 安定版完成・Memory Bank初期化完了

## 最近の変更（重要な順）

### 1. 目的関数の2乗形式への変更 (2026/2/6)

**変更内容**:

```python
# 変更前
obj = alpha * L_max + beta * Σ(y[v] - y[u] + M*t)

# 変更後
obj = alpha * L_max + beta * Σ(y[v] - y[u] + M*t)² + gamma * Σt
```

**理由**:

- エッジスパンの分散を最小化
- 長いエッジに対する強いペナルティ
- トーラス辺に $(M)^2$ の巨大なペナルティ

**影響**: 目的関数が2次計画問題に（Gurobiは自動対応）

### 2. DAG対応の改善 (2026/2/6)

**変更内容**:

- トーラス辺存在性制約 `Σt >= 1` を削除
- トーラス辺数の直接ペナルティ項 `γ * Σt` を追加（γ=1000）

**結果**:

- DAG: トーラス辺数 = 0 ✅
- サイクリックグラフ: 必要最小限のトーラス辺のみ

### 3. torus.pyのバグ修正 (2026/2/6)

**問題**: 最適化結果の出力部分でLを返していなかった

**修正**:

```python
# Before
return y_val, t_val, L  # Lが未定義

# After
L = dict(layer_dict)
return y_val, t_val, layer_dict
```

## 次のステップ

### 短期（すぐできる改善）

1. **ドキュメント整備**
   - README.mdの作成
   - 使用例の充実

2. **テスト拡張**
   - より大規模なグラフのテスト
   - パフォーマンステスト

### 中期（追加機能）

1. **パラメータチューニング**
   - α, β, γの最適値探索
   - グラフサイズに応じた自動調整

2. **可視化の改善**
   - トーラス辺の視覚的強調
   - インタラクティブな描画

### 長期（大きな変更）

1. **大規模グラフ対応**
   - ヒューリスティック手法の導入
   - 階層的分解アプローチ

2. **他の最適化ソルバー対応**
   - OR-Tools, PuLPなどのオープンソース選択肢

## 重要なパターンと学習

### Big-M法の適用

**学習**: Big-M = n が適切

- 小さすぎると制約が機能しない
- 大きすぎると数値不安定

**実装例**:

```python
M = n  # ノード数と同じ
y = m.addVars(V, vtype=GRB.INTEGER, lb=0, ub=n-1)
```

### 2次計画問題への対応

**学習**: Gurobiは2次項を自動検出

```
Model has 25 quadratic objective terms
```

**実装**: 単純に2乗するだけ

```python
(y[v] - y[u] + M * t[u, v]) * (y[v] - y[u] + M * t[u, v])
```

### トーラス辺の最小化戦略

**学習**: 2つのアプローチを併用

1. エッジスパンのペナルティ（間接的）
2. トーラス辺数のペナルティ（直接的）

**効果**: DAGではトーラス辺0、サイクルでは必要最小限

## アクティブな決定事項

### パラメータ設定

現在のデフォルト値:

- **α = 100**: 階層数を最優先
- **β = 1**: エッジスパン最小化は副次的
- **γ = 1000**: トーラス辺を強く抑制

**根拠**: テスト結果から経験的に決定

### 階層の範囲

**決定**: y[v] ∈ {0, 1, ..., n-1}

**理由**: 0-indexで n個の階層（理論上の最大値）

## 現在の制限事項

1. **Gurobiライセンス必須**: Academic License必要
2. **中規模グラフまで**: 〜100ノード程度を想定
3. **可視化の単純さ**: 基本的な階層レイアウトのみ

## プロジェクトの洞察

### 成功要因

1. **Big-M法の効果的活用**: 論理条件を線形化
2. **多目的最適化**: 3つの目標のバランス
3. **包括的テスト**: 22件のテストケースで検証

### 改善の余地

1. **計算効率**: 前処理による変数削減
2. **可視化品質**: レイアウトアルゴリズムの洗練
3. **ユーザビリティ**: GUIやWebインターフェース
